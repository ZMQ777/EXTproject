/**
 * This class encapsulates the user interface for a tabular data set.
 * It acts as a centralized manager for controlling the various interface
 * elements of the view. This includes handling events, such as row and cell
 * level based DOM events. It also reacts to events from the underlying {@link Ext.selection.Model}
 * to provide visual feedback to the user.
 *
 * This class does not provide ways to manipulate the underlying data of the configured
 * {@link Ext.data.Store}.
 *
 * This is the base class for both {@link Ext.grid.View} and {@link Ext.tree.View} and is not
 * to be used directly.
 */
Ext.define('Ext.view.Table',{extend:'Ext.view.View',xtype:['tableview','gridview'],alternateClassName:'Ext.grid.View',requires:['Ext.grid.CellContext','Ext.view.TableLayout','Ext.grid.locking.RowSynchronizer','Ext.view.NodeCache','Ext.util.DelayedTask','Ext.util.MixedCollection','Ext.scroll.TableScroller'],mixins:['Ext.mixin.Queryable'],isTableView:true,config:{selectionModel:{type:'rowmodel'}},inheritableStatics:{normalSideEvents:["deselect","select","beforedeselect","beforeselect","selectionchange"],events:["blur","focus","move","resize","destroy","beforedestroy","boxready","afterrender","render","beforerender","removed","hide","beforehide","show","beforeshow","enable","disable","added","deactivate","beforedeactivate","activate","beforeactivate","cellkeydown","beforecellkeydown","cellmouseup","beforecellmouseup","cellmousedown","beforecellmousedown","cellcontextmenu","beforecellcontextmenu","celldblclick","beforecelldblclick","cellclick","beforecellclick","refresh","itemremove","itemadd","beforeitemupdate","itemupdate","viewready","beforerefresh","unhighlightitem","highlightitem","focuschange","containerkeydown","containercontextmenu","containerdblclick","containerclick","containermouseout","containermouseover","containermouseup","containermousedown","beforecontainerkeydown","beforecontainercontextmenu","beforecontainerdblclick","beforecontainerclick","beforecontainermouseout","beforecontainermouseover","beforecontainermouseup","beforecontainermousedown","itemkeydown","itemcontextmenu","itemdblclick","itemclick","itemmouseleave","itemmouseenter","itemmouseup","itemmousedown","rowclick","rowcontextmenu","rowdblclick","rowkeydown","rowmouseup","rowmousedown","rowkeydown","beforeitemkeydown","beforeitemcontextmenu","beforeitemdblclick","beforeitemclick","beforeitemmouseleave","beforeitemmouseenter","beforeitemmouseup","beforeitemmousedown","statesave","beforestatesave","staterestore","beforestaterestore","uievent","groupcollapse","groupexpand","scroll"]},scrollable:true,componentLayout:'tableview',baseCls:Ext.baseCSSPrefix+'grid-view',unselectableCls:Ext.baseCSSPrefix+'unselectable',firstCls:Ext.baseCSSPrefix+'grid-cell-first',lastCls:Ext.baseCSSPrefix+'grid-cell-last',itemCls:Ext.baseCSSPrefix+'grid-item',selectedItemCls:Ext.baseCSSPrefix+'grid-item-selected',selectedCellCls:Ext.baseCSSPrefix+'grid-cell-selected',focusedItemCls:Ext.baseCSSPrefix+'grid-item-focused',overItemCls:Ext.baseCSSPrefix+'grid-item-over',altRowCls:Ext.baseCSSPrefix+'grid-item-alt',dirtyCls:Ext.baseCSSPrefix+'grid-dirty-cell',rowClsRe:new RegExp('(?:^|\\s*)'+Ext.baseCSSPrefix+'grid-item-alt(?:\\s+|$)','g'),cellRe:new RegExp(Ext.baseCSSPrefix+'grid-cell-([^\\s]+)(?:\\s|$)',''),positionBody:true,positionCells:false,stripeOnUpdate:null,actionableMode:false,trackOver:true,getRowClass:null,stripeRows:true,markDirty:true,ariaRole:'rowgroup',rowAriaRole:'row',cellAriaRole:'gridcell',tpl:['{%','view = values.view;','if (!(columns = values.columns)) {','columns = values.columns = view.ownerCt.getVisibleColumnManager().getColumns();','}','values.fullWidth = 0;','for (i = 0, len = columns.length; i < len; i++) {','column = columns[i];','values.fullWidth += (column.cellWidth = column.lastBox ? column.lastBox.width : column.width || column.minWidth);','}','tableCls=values.tableCls=[];','%}','<div class="'+Ext.baseCSSPrefix+'grid-item-container" role="presentation" style="width:{fullWidth}px">','{[view.renderTHead(values, out, parent)]}','{%','view.renderRows(values.rows, values.columns, values.viewStartIndex, out);','%}','{[view.renderTFoot(values, out, parent)]}','</div>','{% ','view = columns = column = null;','%}',{definitions:'var view, tableCls, columns, i, len, column;',priority:0}],outerRowTpl:['<table id="{rowId}" role="presentation" ','data-boundView="{view.id}" ','data-recordId="{record.internalId}" ','data-recordIndex="{recordIndex}" ','class="{[values.itemClasses.join(" ")]}" cellpadding="0" cellspacing="0" style="{itemStyle};width:0">','{%','this.nextTpl.applyOut(values, out, parent)','%}','</table>',{priority:9999}],rowTpl:['{%','var dataRowCls = values.recordIndex === -1 ? "" : " '+Ext.baseCSSPrefix+'grid-row";','%}','<tr class="{[values.rowClasses.join(" ")]} {[dataRowCls]}"',' role="{rowRole}" {rowAttr:attributes}>','<tpl for="columns">{%','parent.view.renderCell(values, parent.record, parent.recordIndex, parent.rowIndex, xindex - 1, out, parent)','%}','</tpl>','</tr>',{priority:0}],cellTpl:['<td class="{tdCls}" {tdAttr} {cellAttr:attributes}',' style="width:{column.cellWidth}px;<tpl if="tdStyle">{tdStyle}</tpl>"','<tpl if="column.cellFocusable === false">',' role="presentation"','<tpl else>',' role="{cellRole}" tabindex="-1"','</tpl>','  data-columnid="{[values.column.getItemId()]}">','<div {unselectableAttr} class="'+Ext.baseCSSPrefix+'grid-cell-inner {innerCls}" ','style="text-align:{align};<tpl if="style">{style}</tpl>" ','{cellInnerAttr:attributes}>{value}</div>','</td>',{priority:0}],refreshSelmodelOnRefresh:false,scrollableType:'table',tableValues:{},rowValues:{itemClasses:[],rowClasses:[]},cellValues:{classes:[Ext.baseCSSPrefix+'grid-cell '+Ext.baseCSSPrefix+'grid-td']},constructor:function(config){if(config.grid.isTree){config.baseCls=Ext.baseCSSPrefix+'tree-view'}this.callParent([config])},hasVariableRowHeight:function(fromLockingPartner){var me=this;return me.variableRowHeight||me.store.isGrouped()||me.getVisibleColumnManager().hasVariableRowHeight()||(!fromLockingPartner&&me.lockingPartner&&me.lockingPartner.hasVariableRowHeight(true))},initComponent:function(){var me=this;if(me.columnLines){me.addCls(me.grid.colLinesCls)}if(me.rowLines){me.addCls(me.grid.rowLinesCls)}me.body=new Ext.dom.Fly();me.body.id=me.id+'gridBody';if(!me.trackOver){me.overItemCls=null}me.headerCt.view=me;me.grid.view=me;me.initFeatures(me.grid);me.itemSelector=me.getItemSelector();me.all=new Ext.view.NodeCache(me);me.callParent()},applySelectionModel:function(selModel,oldSelModel){var me=this,grid=me.ownerGrid,defaultType=selModel.type,disableSelection=me.disableSelection||grid.disableSelection;if(!oldSelModel){if(!(selModel&&selModel.isSelectionModel)){selModel=grid.selModel||selModel}}if(selModel){if(selModel.isSelectionModel){selModel.allowDeselect=grid.allowDeselect||selModel.selectionMode!=='SINGLE';selModel.locked=disableSelection}else{if(typeof selModel==='string'){selModel={type:selModel}}else{selModel.type=grid.selType||selModel.selType||selModel.type||defaultType}if(!selModel.mode){if(grid.simpleSelect){selModel.mode='SIMPLE'}else if(grid.multiSelect){selModel.mode='MULTI'}}selModel=Ext.Factory.selection(Ext.apply({allowDeselect:grid.allowDeselect,locked:disableSelection},selModel))}}return selModel},updateSelectionModel:function(selModel,oldSelModel){var me=this;if(oldSelModel){oldSelModel.un({scope:me,lastselectedchanged:me.updateBindSelection,selectionchange:me.updateBindSelection});Ext.destroy(me.selModelRelayer)}me.selModelRelayer=me.relayEvents(selModel,['selectionchange','beforeselect','beforedeselect','select','deselect','focuschange']);selModel.on({scope:me,lastselectedchanged:me.updateBindSelection,selectionchange:me.updateBindSelection});me.selModel=selModel},getVisibleColumnManager:function(){return this.ownerCt.getVisibleColumnManager()},getColumnManager:function(){return this.ownerCt.getColumnManager()},getTopLevelVisibleColumnManager:function(){return this.ownerGrid.getVisibleColumnManager()},moveColumn:function(fromIdx,toIdx,colsToMove){var me=this,multiMove=colsToMove>1,range=multiMove&&document.createRange?document.createRange():null,fragment=multiMove&&!range?document.createDocumentFragment():null,destinationCellIdx=toIdx,colCount=me.getGridColumns().length,lastIndex=colCount-1,doFirstLastClasses=(me.firstCls||me.lastCls)&&(toIdx===0||toIdx===colCount||fromIdx===0||fromIdx===lastIndex),i,j,rows,len,tr,cells,colGroups;if(me.rendered&&toIdx!==fromIdx){rows=me.el.query(me.rowSelector);for(i=0,len=rows.length;i<len;i+=1){tr=rows[i];cells=tr.childNodes;if(doFirstLastClasses){if(cells.length===1){Ext.fly(cells[0]).addCls(me.firstCls);Ext.fly(cells[0]).addCls(me.lastCls);continue}if(fromIdx===0){Ext.fly(cells[0]).removeCls(me.firstCls);Ext.fly(cells[1]).addCls(me.firstCls)}else if(fromIdx===lastIndex){Ext.fly(cells[lastIndex]).removeCls(me.lastCls);Ext.fly(cells[lastIndex-1]).addCls(me.lastCls)}if(toIdx===0){Ext.fly(cells[0]).removeCls(me.firstCls);Ext.fly(cells[fromIdx]).addCls(me.firstCls)}else if(toIdx===colCount){Ext.fly(cells[lastIndex]).removeCls(me.lastCls);Ext.fly(cells[fromIdx]).addCls(me.lastCls)}}if(multiMove){if(range){range.setStartBefore(cells[fromIdx]);range.setEndAfter(cells[fromIdx+colsToMove-1]);fragment=range.extractContents()}else{for(j=0;j<colsToMove;j+=1){fragment.appendChild(cells[fromIdx])}}tr.insertBefore(fragment,cells[destinationCellIdx]||null)}else{tr.insertBefore(cells[fromIdx],cells[destinationCellIdx]||null)}}colGroups=me.el.query('colgroup');for(i=0,len=colGroups.length;i<len;i+=1){tr=colGroups[i];if(multiMove){if(range){range.setStartBefore(tr.childNodes[fromIdx]);range.setEndAfter(tr.childNodes[fromIdx+colsToMove-1]);fragment=range.extractContents()}else{for(j=0;j<colsToMove;j+=1){fragment.appendChild(tr.childNodes[fromIdx])}}tr.insertBefore(fragment,tr.childNodes[destinationCellIdx]||null)}else{tr.insertBefore(tr.childNodes[fromIdx],tr.childNodes[destinationCellIdx]||null)}}}},scrollToTop:Ext.emptyFn,addElListener:function(eventName,fn,scope){this.mon(this,eventName,fn,scope,{element:'el'})},getGridColumns:function(){return this.ownerCt.getVisibleColumnManager().getColumns()},getHeaderAtIndex:function(index){return this.ownerCt.getVisibleColumnManager().getHeaderAtIndex(index)},getCell:function(record,column){var row=this.getRow(record);if(row){if(typeof column==='number'){column=this.getHeaderAtIndex(column)}return Ext.fly(row).down(column.getCellSelector())}},getFeature:function(id){var features=this.featuresMC;if(features){return features.get(id)}},findFeature:function(ftype){if(this.features){return Ext.Array.findBy(this.features,function(feature){if(feature.ftype===ftype){return true}})}},initFeatures:function(grid){var me=this,i,features,feature,len;me.tpl=this.lookupTpl('tpl');me.rowTpl=me.lookupTpl('rowTpl');me.addRowTpl(me.lookupTpl('outerRowTpl'));me.cellTpl=me.lookupTpl('cellTpl');me.featuresMC=new Ext.util.MixedCollection();features=me.features=me.constructFeatures();len=features?features.length:0;for(i=0;i<len;i+=1){feature=features[i];feature.view=me;feature.grid=grid;me.featuresMC.add(feature);feature.init(grid)}},renderTHead:function(values,out,parent){var headers=values.view.headerFns,len,i;if(headers){for(i=0,len=headers.length;i<len;i+=1){headers[i].call(this,values,out,parent)}}},addHeaderFn:function(fn){var headers=this.headerFns;if(!headers){headers=this.headerFns=[]}headers.push(fn)},renderTFoot:function(values,out,parent){var footers=values.view.footerFns,len,i;if(footers){for(i=0,len=footers.length;i<len;i+=1){footers[i].call(this,values,out,parent)}}},addFooterFn:function(fn){var footers=this.footerFns;if(!footers){footers=this.footerFns=[]}footers.push(fn)},addTpl:function(newTpl){return this.insertTpl('tpl',newTpl)},addRowTpl:function(newTpl){return this.insertTpl('rowTpl',newTpl)},addCellTpl:function(newTpl){return this.insertTpl('cellTpl',newTpl)},insertTpl:function(which,newTpl){var me=this,tpl,prevTpl;if(newTpl.isTemplate){newTpl=Ext.Object.chain(newTpl)}else{newTpl=new Ext.XTemplate('{%this.nextTpl.applyOut(values, out, parent);%}',newTpl)}for(tpl=me[which];newTpl.priority<tpl.priority;tpl=tpl.nextTpl){prevTpl=tpl}if(prevTpl){prevTpl.nextTpl=newTpl}else{me[which]=newTpl}newTpl.nextTpl=tpl;return newTpl},tplApplyOut:function(values,out,parent){if(this.before){if(this.before(values,out,parent)===false){return}}this.nextTpl.applyOut(values,out,parent);if(this.after){this.after(values,out,parent)}},constructFeatures:function(){var me=this,features=me.features,feature,result,i=0,len;if(features){result=[];len=features.length;for(;i<len;i+=1){feature=features[i];if(!feature.isFeature){feature=Ext.create('feature.'+feature.ftype,feature)}result[i]=feature}}return result},beforeRender:function(){this.callParent();if(!this.enableTextSelection){this.protoEl.unselectable()}},getElConfig:function(){var config=this.callParent();delete config['aria-hidden'];delete config['aria-disabled'];return config},onBindStore:function(store){var me=this,bufferedRenderer=me.bufferedRenderer;if(bufferedRenderer&&bufferedRenderer.store!==store){bufferedRenderer.bindStore(store)}if(me.all&&me.all.getCount()&&!me.grid.reconfiguring){me.clearViewEl()}me.callParent(arguments)},onOwnerGridHide:function(){var scroller=this.getScrollable(),bufferedRenderer=this.bufferedRederer;if(scroller){scroller.suspendPartnerSync()}if(bufferedRenderer){bufferedRenderer.disable()}},onOwnerGridShow:function(){var scroller=this.getScrollable(),bufferedRenderer=this.bufferedRederer;if(scroller){scroller.resumePartnerSync()}if(bufferedRenderer){bufferedRenderer.enable()}},getStoreListeners:function(store){var me=this,result=me.callParent([store]),dataSource=me.dataSource;if(dataSource&&dataSource.isFeatureStore){delete result.add;delete result.remove}if(me.bufferedRenderer){delete result.clear}result.beforepageremove=me.beforePageRemove;return result},beforePageRemove:function(pageMap,pageNumber){var rows=this.all,pageSize=pageMap.getPageSize();if(rows.startIndex>=(pageNumber-1)*pageSize&&rows.endIndex<=(pageNumber*pageSize-1)){pageMap.get(pageNumber);return false}},onViewScroll:function(scroller,x,y){if(!this.ignoreScroll){this.callParent([scroller,x,y])}},createRowElement:function(record,index,updateColumns){var me=this,div=me.renderBuffer,tplData=me.collectData([record],index);tplData.columns=updateColumns;me.tpl.overwrite(div,tplData);me.cleanupData();return Ext.fly(div).down(me.getNodeContainerSelector(),true).firstChild},bufferRender:function(records,index){var me=this,div=me.renderBuffer,result,range=document.createRange?document.createRange():null;me.tpl.overwrite(div,me.collectData(records,index));me.cleanupData();Ext.fly(div).saveTabbableState({skipSelf:true,includeHidden:true});div=Ext.fly(div).down(me.getNodeContainerSelector(),true);if(range){range.selectNodeContents(div);result=range.extractContents()}else{result=document.createDocumentFragment();while(div.firstChild){result.appendChild(div.firstChild)}}return{fragment:result,children:Ext.Array.toArray(result.childNodes)}},collectData:function(records,startIndex){var me=this,tableValues=me.tableValues;me.rowValues.view=me;tableValues.view=me;tableValues.rows=records;tableValues.columns=null;tableValues.viewStartIndex=startIndex;tableValues.tableStyle='width:'+me.headerCt.getTableWidth()+'px';return tableValues},cleanupData:function(){var tableValues=this.tableValues;tableValues.view=tableValues.columns=tableValues.rows=this.rowValues.view=null},refreshSize:function(forceLayout){var me=this,bodySelector=me.getBodySelector(),lockingPartner=me.lockingPartner,restoreFocus=me.saveFocusState();if(bodySelector){me.body.attach(me.el.down(bodySelector,true))}if(!me.hasLoadingHeight){Ext.suspendLayouts();me.callParent(arguments);if(forceLayout||(me.hasVariableRowHeight()&&me.dataSource.getCount())){me.grid.updateLayout()}Ext.resumeLayouts(!lockingPartner||!lockingPartner.grid.isVisible()||(lockingPartner.all.getCount()===me.all.getCount()));restoreFocus()}},isLayoutRoot:function(){return false},clearViewEl:function(leaveNodeContainer){var me=this,nodeContainer;if(me.rendered){me.callParent();if(!leaveNodeContainer){nodeContainer=Ext.get(me.getNodeContainer());if(nodeContainer&&nodeContainer.dom!==me.getTargetEl().dom){nodeContainer.destroy()}}}},getRefItems:function(deep){var me=this,rowContexts=me.ownerGrid.liveRowContexts,widgetCount,i,widgets,widget,recordId,result=me.callParent(arguments);for(recordId in rowContexts){widgets=rowContexts[recordId].getWidgets();widgetCount=widgets.length;for(i=0;i<widgetCount;i+=1){widget=widgets[i];if(me.isAncestor(widget)){result[result.length]=widget;if(deep&&widget.getRefItems){result.push.apply(result,widget.getRefItems(true))}}}}return result},getMaskTarget:function(){return this.ownerCt.body},statics:{getBoundView:function(node){return Ext.getCmp(node.getAttribute('data-boundView'))}},getRecord:function(node){if(this.store.destroyed){return}if(node.isModel){return node}node=this.getNode(node);if(node){return this.dataSource.getByInternalId(node.getAttribute('data-recordId'))}},indexOf:function(node){node=this.getNode(node);if(!node&&node!==0){return -1}return this.all.indexOf(node)},indexInStore:function(node){return node?this.dataSource.indexOf(this.getRecord(node)):-1},indexOfRow:function(record){var dataSource=this.dataSource,idx;if(record.isCollapsedPlaceholder){idx=dataSource.indexOfPlaceholder(record)}else{idx=dataSource.indexOf(record)}return idx},renderRows:function(rows,columns,viewStartIndex,out){var me=this,rowValues=me.rowValues,rowCount=rows.length,i;rowValues.view=me;rowValues.columns=columns;rowValues.rowRole=me.rowAriaRole;me.cellValues.cellRole=me.cellAriaRole;for(i=0;i<rowCount;i+=1,viewStartIndex+=1){rowValues.itemClasses.length=rowValues.rowClasses.length=0;me.renderRow(rows[i],viewStartIndex,out)}rowValues.view=rowValues.columns=rowValues.record=null},renderColumnSizer:function(values,out){var columns=values.columns||this.getGridColumns(),len=columns.length,i,column,width;out.push('<colgroup role="presentation">');for(i=0;i<len;i+=1){column=columns[i];width=column.cellWidth?column.cellWidth:Ext.grid.header.Container.prototype.defaultWidth;out.push('<col role="presentation" class="',Ext.baseCSSPrefix,'grid-cell-',columns[i].getItemId(),'" style="width:'+width+'px">')}out.push('</colgroup>')},renderRow:function(record,rowIdx,out){var me=this,isMetadataRecord=rowIdx===-1,selModel=me.selectionModel,rowValues=me.rowValues,itemClasses=rowValues.itemClasses,rowClasses=rowValues.rowClasses,itemCls=me.itemCls,cls,rowTpl=me.rowTpl;rowValues.rowAttr={};rowValues.record=record;rowValues.recordId=record.internalId;rowValues.recordIndex=me.store.indexOf(record);rowValues.rowIndex=rowIdx;rowValues.rowId=me.getRowId(record);rowValues.itemCls=rowValues.rowCls='';if(!rowValues.columns){rowValues.columns=me.ownerCt.getVisibleColumnManager().getColumns()}itemClasses.length=rowClasses.length=0;if(!isMetadataRecord){itemClasses[0]=itemCls;if(!me.ownerCt.disableSelection&&selModel.isRowSelected){if(selModel.isRowSelected(record)){itemClasses.push(me.selectedItemCls)}}if(me.stripeRows&&rowIdx%2!==0){itemClasses.push(me.altRowCls)}if(me.getRowClass){cls=me.getRowClass(record,rowIdx,null,me.dataSource);if(cls){rowClasses.push(cls)}}}if(out){rowTpl.applyOut(rowValues,out,me.tableValues)}else{return rowTpl.apply(rowValues,me.tableValues)}},renderCell:function(column,record,recordIndex,rowIndex,columnIndex,out){var me=this,fullIndex,selModel=me.selectionModel,cellValues=me.cellValues,classes=cellValues.classes,fieldValue=record.data[column.dataIndex],cellTpl=me.cellTpl,enableTextSelection=column.enableTextSelection,value,clsInsertPoint,lastFocused=me.navigationModel.getPosition();if(enableTextSelection==null){enableTextSelection=me.enableTextSelection}cellValues.record=record;cellValues.column=column;cellValues.recordIndex=recordIndex;cellValues.rowIndex=rowIndex;cellValues.columnIndex=cellValues.cellIndex=columnIndex;cellValues.align=column.textAlign;cellValues.innerCls=column.innerCls;cellValues.tdCls=cellValues.tdStyle=cellValues.tdAttr=cellValues.style="";cellValues.unselectableAttr=enableTextSelection?'':'unselectable="on"';classes[1]=column.getCellId();clsInsertPoint=2;if(column.renderer&&column.renderer.call){fullIndex=me.ownerCt.columnManager.getHeaderIndex(column);value=column.renderer.call(column.usingDefaultRenderer?column:column.scope||me.ownerCt,fieldValue,cellValues,record,recordIndex,fullIndex,me.dataSource,me);if(cellValues.css){record.cssWarning=true;cellValues.tdCls+=' '+cellValues.css;cellValues.css=null}if(cellValues.tdCls){classes[clsInsertPoint++]=cellValues.tdCls}}else{value=fieldValue}cellValues.value=(value==null||value.length===0)?column.emptyCellText:value;if(column.tdCls){classes[clsInsertPoint++]=column.tdCls}if(me.markDirty&&record.dirty&&record.isModified(column.dataIndex)){classes[clsInsertPoint++]=me.dirtyCls;if(column.dirtyTextElementId){cellValues.tdAttr=(cellValues.tdAttr?cellValues.tdAttr+' ':'')+'aria-describedby="'+column.dirtyTextElementId+'"'}}if(column.isFirstVisible){classes[clsInsertPoint++]=me.firstCls}if(column.isLastVisible){classes[clsInsertPoint++]=me.lastCls}if(!enableTextSelection){classes[clsInsertPoint++]=me.unselectableCls}if(selModel&&(selModel.isCellModel||selModel.isSpreadsheetModel)&&selModel.isCellSelected(me,recordIndex,column)){classes[clsInsertPoint++]=me.selectedCellCls}if(lastFocused&&lastFocused.record.id===record.id&&lastFocused.column===column){classes[clsInsertPoint++]=me.focusedItemCls}classes.length=clsInsertPoint;cellValues.tdCls=classes.join(' ');cellTpl.applyOut(cellValues,out);cellValues.column=cellValues.record=null},getRow:function(nodeInfo){var fly;if((!nodeInfo&&nodeInfo!==0)||!this.rendered){return null}if(nodeInfo.target){nodeInfo=nodeInfo.target}if(Ext.isString(nodeInfo)){return Ext.fly(nodeInfo).down(this.rowSelector,true)}if(Ext.isNumber(nodeInfo)){fly=this.all.item(nodeInfo);return fly&&fly.down(this.rowSelector,true)}if(nodeInfo.isModel){return this.getRowByRecord(nodeInfo)}fly=Ext.fly(nodeInfo);if(fly.is(this.itemSelector)){return this.getRowFromItem(fly)}return fly.findParent(this.rowSelector,this.getTargetEl());},getRowId:function(record){return this.id+'-record-'+record.internalId},constructRowId:function(internalId){return this.id+'-record-'+internalId},getNodeById:function(id){id=this.constructRowId(id);return this.retrieveNode(id,false)},getRowById:function(id){id=this.constructRowId(id);return this.retrieveNode(id,true)},getNodeByRecord:function(record){return this.retrieveNode(this.getRowId(record),false)},getRowByRecord:function(record){return this.retrieveNode(this.getRowId(record),true)},getRowFromItem:function(item){var rows=Ext.getDom(item).tBodies[0].childNodes,len=rows.length,i;for(i=0;i<len;i+=1){if(Ext.fly(rows[i]).is(this.rowSelector)){return rows[i]}}},retrieveNode:function(id,dataRow){var result=this.el.getById(id,true);if(dataRow&&result){return Ext.fly(result).down(this.rowSelector,true)}return result},updateIndexes:Ext.emptyFn,bodySelector:'div.'+Ext.baseCSSPrefix+'grid-item-container',nodeContainerSelector:'div.'+Ext.baseCSSPrefix+'grid-item-container',itemSelector:'table.'+Ext.baseCSSPrefix+'grid-item',rowSelector:'tr.'+Ext.baseCSSPrefix+'grid-row',cellSelector:'td.'+Ext.baseCSSPrefix+'grid-cell',sizerSelector:'.'+Ext.baseCSSPrefix+'grid-cell',innerSelector:'div.'+Ext.baseCSSPrefix+'grid-cell-inner',getBodySelector:function(){return this.bodySelector},getColumnSizerSelector:function(header){var selector=this.sizerSelector+'-'+header.getItemId();return 'td'+selector+',col'+selector},getItemSelector:function(){return this.itemSelector},getCellSelector:function(header){return header?header.getCellSelector():this.cellSelector},getCellInnerSelector:function(header){return this.getCellSelector(header)+' '+this.innerSelector},addRowCls:function(rowInfo,cls){var row=this.getRow(rowInfo);if(row){Ext.fly(row).addCls(cls)}},removeRowCls:function(rowInfo,cls){var row=this.getRow(rowInfo);if(row){Ext.fly(row).removeCls(cls)}},onRowSelect:function(rowIdx){var me=this,rowNode;me.addItemCls(rowIdx,me.selectedItemCls);rowNode=me.getRow(rowIdx);if(rowNode){rowNode.setAttribute('aria-selected',true)}if(Ext.isIE8){me.repaintBorder(rowIdx+1)}},onRowDeselect:function(rowIdx){var me=this,rowNode;me.removeItemCls(rowIdx,me.selectedItemCls);rowNode=me.getRow(rowIdx);if(rowNode){rowNode.removeAttribute('aria-selected')}if(Ext.isIE8){me.repaintBorder(rowIdx+1)}},onCellSelect:function(position){var cell=this.getCellByPosition(position);if(cell){cell.addCls(this.selectedCellCls);cell.dom.setAttribute('aria-selected',true)}},onCellDeselect:function(position){var cell=this.getCellByPosition(position,true);if(cell){Ext.fly(cell).removeCls(this.selectedCellCls);cell.removeAttribute('aria-selected')}},getCellInclusive:function(position,returnDom){if(position){var row=this.getRow(position.row),header=this.ownerCt.getColumnManager().getHeaderAtIndex(position.column);if(header&&row){return Ext.fly(row).down(this.getCellSelector(header),returnDom)}}return false},getColumnByPosition:function(position){var view,column;if(position){column=position.column;if(column&&!column.destroyed&&column.isColumn){return column}else{view=position.view||this;column=typeof column==='number'?column:position.colIdx;return view.getVisibleColumnManager().getHeaderAtIndex(column)}}return false},getCellByPosition:function(position,returnDom){if(position){var view=position.view||this,row=view.getRow(position.record||position.row),header;header=view.getColumnByPosition(position);if(header&&row){return Ext.fly(row).down(view.getCellSelector(header),returnDom)}}return false},onFocusEnter:function(e){var me=this,fromComponent=e.fromComponent,navigationModel=me.getNavigationModel(),focusPosition,cell,focusTarget;if(me.containsFocus){return Ext.Component.prototype.onFocusEnter.call(me,e)}if(me.actionableMode){if(me.actionPosition){me.el.dom.setAttribute('tabIndex','-1');me.cellFocused=true;return}me.ownerGrid.setActionableMode(false)}e=e.event;if(!me.cellFocused&&me.all.getCount()&&me.dataSource.getCount()){focusTarget=e.getTarget();if(focusTarget===me.el.dom){if(me.lastFocused==='scrollbar'){e.relatedTarget.focus();return}focusPosition=me.getDefaultFocusPosition(fromComponent);if(!focusPosition){e.stopEvent();me.el.focus();return}focusTarget=null }else if(focusTarget===me.tabGuardEl){focusPosition=new Ext.grid.CellContext(me).setPosition(me.all.endIndex,me.getVisibleColumnManager().getColumns().length-1);focusTarget=null }else if(cell=e.getTarget(me.getCellSelector())){if(focusTarget===cell){focusPosition=new Ext.grid.CellContext(me).setPosition(me.getRecord(focusTarget),me.getHeaderByCell(cell));focusTarget=null}else if(focusTarget&&Ext.fly(focusTarget).isFocusable()&&me.el.contains(focusTarget)){focusPosition=new Ext.grid.CellContext(me).setPosition(me.getRecord(focusTarget),me.getHeaderByCell(cell))}}}if(focusPosition){me.toggleChildrenTabbability(false);if(focusTarget){if(me.ownerGrid.setActionableMode(true,focusPosition)){focusPosition=null;Ext.fly(focusTarget).focus()}}if(focusPosition){navigationModel.setPosition(focusPosition,null,e,null,true)}me.cellFocused=me.el.contains(Ext.Element.getActiveElement());if(me.cellFocused){me.el.dom.setAttribute('tabIndex','-1')}}Ext.Component.prototype.onFocusEnter.call(me,e)},onFocusLeave:function(e){var me=this,isLeavingGrid=!me.lockingPartner||!e.toComponent||(e.toComponent!==me.lockingPartner&&!me.lockingPartner.isAncestor(e.toComponent));if(!me.refreshing){if(me.cellFocused){if(isLeavingGrid){me.getNavigationModel().setPosition(null,null,e.event,null,true)}me.cellFocused=false;me.focusEl=me.el;me.focusEl.dom.setAttribute('tabIndex',0)}if(isLeavingGrid){if(me.ownerGrid.actionableMode){me.lastFocused=me.actionPosition;me.ownerGrid.setActionableMode(false)}}else{me.actionPosition=null}Ext.Component.prototype.onFocusLeave.call(me,e)}},onRowFocus:function(rowIdx,highlight,supressFocus){var me=this;if(highlight){me.addItemCls(rowIdx,me.focusedItemCls);if(!supressFocus){me.focusRow(rowIdx)}}else{me.removeItemCls(rowIdx,me.focusedItemCls)}if(Ext.isIE8){me.repaintBorder(rowIdx+1)}},focusRow:function(row,delay){var me=this,focusTask=me.getFocusTask();if(delay){focusTask.delay(Ext.isNumber(delay)?delay:10,me.focusRow,me,[row,false]);return}focusTask.cancel();if(me.isVisible(true)){me.getNavigationModel().setPosition(me.getRecord(row))}},focusNode:function(row,delay){this.focusRow(row,delay)},scrollRowIntoView:function(row,animate){row=this.getRow(row);if(row){this.scrollElIntoView(row,false,animate)}},focusCell:function(position,delay){var me=this,cell,focusTask=me.getFocusTask();if(delay){focusTask.delay(Ext.isNumber(delay)?delay:10,me.focusCell,me,[position,false]);return}focusTask.cancel();if(me.isVisible(true)&&(cell=me.getCellByPosition(position))){me.getNavigationModel().setPosition(position)}},findFocusPosition:function(from,currentPosition,forward,keyEvent){var me=this,cell=currentPosition.cellElement,actionables=me.ownerGrid.actionables,len=actionables.length,position,tabbableChildren,focusTarget,i;position=currentPosition.clone();tabbableChildren=Ext.fly(cell).findTabbableElements();focusTarget=tabbableChildren[Ext.Array.indexOf(tabbableChildren,from)+(forward?1:-1)];while(!focusTarget&&(cell=cell[forward?'nextSibling':'previousSibling'])){position.setColumn(me.getHeaderByCell(cell));for(i=0;i<len;i+=1){actionables[i].activateCell(position)}cell=position.getCell(true);if(cell&&(tabbableChildren=Ext.fly(cell).findTabbableElements()).length){focusTarget=tabbableChildren[forward?0:tabbableChildren.length-1]}}return{target:focusTarget,position:position}},getDefaultFocusPosition:function(fromComponent){var me=this,store=me.dataSource,focusPosition=me.lastFocused,newPosition=new Ext.grid.CellContext((me.isNormalView&&me.lockingPartner.grid.isVisible()&&!me.lockingPartner.grid.collapsed)?me.lockingPartner:me).setPosition(0,0),targetCell,scroller;if(fromComponent){if(fromComponent.isColumn&&fromComponent.cellFocusable!==false&&fromComponent.getView()===me){if(!focusPosition){focusPosition=newPosition}focusPosition.setColumn(fromComponent)}else if(fromComponent.isTableView){focusPosition=new Ext.grid.CellContext(me).setPosition(fromComponent.lastFocused.record,0)}}if(focusPosition){scroller=me.getScrollable();if(!store.contains(focusPosition.record)||(scroller&&!scroller.isInView(focusPosition.getRow()).y)){focusPosition.setRow(store.getAt(Math.min(focusPosition.rowIdx,store.getCount()-1)))}}else{focusPosition=newPosition;targetCell=me.ownerGrid.view.el.down(me.getCellSelector()+'[tabIndex="-1"]');if(targetCell){focusPosition.setPosition(me.getRecord(targetCell),me.getHeaderByCell(targetCell))}else{focusPosition=null}}return focusPosition},getLastFocused:function(){var me=this,lastFocused=me.lastFocused;if(lastFocused&&lastFocused.record&&lastFocused.column){if(me.dataSource.indexOf(lastFocused.record)!==-1&&me.getVisibleColumnManager().indexOf(lastFocused.column)!==-1&&me.getNode(lastFocused.record)){return lastFocused}}},scrollCellIntoView:function(cell,animate){if(cell.isCellContext){cell=this.getCellByPosition(cell)}if(cell){this.scrollElIntoView(cell,null,animate)}},scrollElIntoView:function(el,hscroll,animate){var scroller=this.getScrollable();if(scroller){scroller.scrollIntoView(el,hscroll,animate)}},syncRowHeightBegin:function(){var me=this,itemEls=me.all,ln=itemEls.count,synchronizer=[],RowSynchronizer=Ext.grid.locking.RowSynchronizer,i,j,rowSync;for(i=0,j=itemEls.startIndex;i<ln;i+=1,j+=1){synchronizer[i]=rowSync=new RowSynchronizer(me,itemEls.elements[j]);rowSync.reset()}return synchronizer},syncRowHeightClear:function(synchronizer){var me=this,itemEls=me.all,ln=itemEls.count,i;for(i=0;i<ln;i+=1){synchronizer[i].reset()}},syncRowHeightMeasure:function(synchronizer){var ln=synchronizer.length,i;for(i=0;i<ln;i+=1){synchronizer[i].measure()}},syncRowHeightFinish:function(synchronizer,otherSynchronizer){var ln=synchronizer.length,bufferedRenderer=this.bufferedRenderer,i;for(i=0;i<ln;i+=1){synchronizer[i].finish(otherSynchronizer[i])}if(bufferedRenderer){bufferedRenderer.syncRowHeightsFinish()}},refreshNode:function(record){if(Ext.isNumber(record)){record=this.store.getAt(record)}this.handleUpdate(this.dataSource,record,null,null,null,true)},handleUpdate:function(store,record,operation,changedFieldNames,info,allColumns){operation=operation||Ext.data.Model.EDIT;var me=this,recordIndex=me.store.indexOf(record),rowTpl=me.rowTpl,markDirty=me.markDirty,dirtyCls=me.dirtyCls,clearDirty=operation!==Ext.data.Model.EDIT,columnsToUpdate=[],hasVariableRowHeight=me.variableRowHeight,updateTypeFlags=0,ownerCt=me.ownerCt,cellFly=me.cellFly||(me.self.prototype.cellFly=new Ext.dom.Fly()),oldItemDom,oldDataRow,newItemDom,newAttrs,attLen,attName,attrIndex,overItemCls,columns,column,len,i,cellUpdateFlag,cell,fieldName,value,defaultRenderer,scope,elData,emptyValue;if(me.viewReady){me.updatingRows=true;oldItemDom=me.getNodeByRecord(record);if(oldItemDom){if(record.isCollapsedPlaceholder){Ext.fly(oldItemDom).syncContent(me.createRowElement(record,me.indexOfRow(record)));return}overItemCls=me.overItemCls;columns=me.ownerCt.getVisibleColumnManager().getColumns();if(allColumns){columnsToUpdate=columns;updateTypeFlags=1}else{for(i=0,len=columns.length;i<len;i+=1){column=columns[i];if(column.preventUpdate){cell=Ext.fly(oldItemDom).down(column.getCellSelector(),true);if(cell&&!clearDirty&&markDirty){cellFly.attach(cell);if(record.isModified(column.dataIndex)){cellFly.addCls(dirtyCls);if(column.dirtyTextElementId){cell.setAttribute('aria-describedby',column.dirtyTextElementId)}}else{cellFly.removeCls(dirtyCls);cell.removeAttribute('aria-describedby')}}}else{cellUpdateFlag=me.shouldUpdateCell(record,column,changedFieldNames);if(cellUpdateFlag){updateTypeFlags=updateTypeFlags|cellUpdateFlag;columnsToUpdate[columnsToUpdate.length]=column;hasVariableRowHeight=hasVariableRowHeight||column.variableRowHeight}}}}me.fireEvent('beforeitemupdate',record,recordIndex,oldItemDom,columnsToUpdate);if(me.getRowClass||!me.getRowFromItem(oldItemDom)||(updateTypeFlags&1)||(oldItemDom.tBodies[0].childNodes.length>1)){elData=oldItemDom._extData;newItemDom=me.createRowElement(record,me.indexOfRow(record),columnsToUpdate);if(Ext.fly(oldItemDom,'_internal').hasCls(overItemCls)){Ext.fly(newItemDom).addCls(overItemCls)}if(Ext.isIE9m&&oldItemDom.mergeAttributes){oldItemDom.mergeAttributes(newItemDom,true)}else{newAttrs=newItemDom.attributes;attLen=newAttrs.length;for(attrIndex=0;attrIndex<attLen;attrIndex+=1){attName=newAttrs[attrIndex].name;if(attName!=='id'){oldItemDom.setAttribute(attName,newAttrs[attrIndex].value)}}}if(elData){elData.isSynchronized=false}if(columns.length&&(oldDataRow=me.getRow(oldItemDom))){me.updateColumns(oldDataRow,Ext.fly(newItemDom).down(me.rowSelector,true),columnsToUpdate)}while(rowTpl){if(rowTpl.syncContent){if(rowTpl.syncContent(oldItemDom,newItemDom,changedFieldNames?columnsToUpdate:null)===false){break}}rowTpl=rowTpl.nextTpl }}else{for(i=0,len=columnsToUpdate.length;i<len;i+=1){column=columnsToUpdate[i];fieldName=column.dataIndex;value=record.get(fieldName);cell=Ext.fly(oldItemDom).down(column.getCellSelector(),true);cellFly.attach(cell);if(!clearDirty&&markDirty){if(record.isModified(column.dataIndex)){cellFly.addCls(dirtyCls);if(column.dirtyTextElementId){cell.setAttribute('aria-describedby',column.dirtyTextElementId)}}else{cellFly.removeCls(dirtyCls);cell.removeAttribute('aria-describedby')}}defaultRenderer=column.usingDefaultRenderer;scope=defaultRenderer?column:column.scope;if(column.updater){Ext.callback(column.updater,scope,[cell,value,record,me,me.dataSource],0,column,ownerCt)}else{if(column.renderer){value=Ext.callback(column.renderer,scope,[value,null,record,0,0,me.dataSource,me],0,column,ownerCt)}emptyValue=value==null||value.length===0;value=emptyValue?column.emptyCellText:value;if(column.producesHTML||emptyValue){cellFly.down(me.innerSelector,true).innerHTML=value}else{cellFly.down(me.innerSelector,true).childNodes[0].data=value}}if(me.highlightClass){Ext.fly(cell).addCls(me.highlightClass);if(!me.changedCells){me.self.prototype.changedCells=[];me.prototype.clearChangedTask=new Ext.util.DelayedTask(me.clearChangedCells,me.prototype);me.clearChangedTask.delay(me.unhighlightDelay)}me.changedCells.push({cell:cell,cls:me.highlightClass,expires:Ext.Date.now()+1000})}}}if(clearDirty&&markDirty&&!record.dirty){Ext.fly(oldItemDom,'_internal').select('.'+dirtyCls).removeCls(dirtyCls).set({'aria-describedby':undefined})}if(hasVariableRowHeight){Ext.suspendLayouts()}me.fireEvent('itemupdate',record,recordIndex,oldItemDom,me);if(hasVariableRowHeight){me.ownerGrid.updateLayout();Ext.resumeLayouts(true)}}me.updatingRows=false}},clearChangedCells:function(){var me=this,now=Ext.Date.now(),changedCell;for(var i=0,len=me.changedCells.length;i<len;){changedCell=me.changedCells[i];if(changedCell.expires<=now){Ext.fly(changedCell.cell).removeCls(changedCell.highlightClass);Ext.Array.erase(me.changedCells,i,1);len-=1}else{break}}if(len){me.clearChangedTask.delay(me.unhighlightDelay)}},updateColumns:function(oldRow,newRow,columnsToUpdate){var me=this,newAttrs,attLen,attName,attrIndex,colCount=columnsToUpdate.length,colIndex,column,oldCell,newCell,cellSelector=me.getCellSelector(),elData;if(oldRow.mergeAttributes){oldRow.mergeAttributes(newRow,true)}else{newAttrs=newRow.attributes;attLen=newAttrs.length;for(attrIndex=0;attrIndex<attLen;attrIndex+=1){attName=newAttrs[attrIndex].name;if(attName!=='id'){oldRow.setAttribute(attName,newAttrs[attrIndex].value)}}}elData=oldRow._extData;if(elData){elData.isSynchronized=false}oldRow=Ext.get(oldRow);newRow=Ext.get(newRow);for(colIndex=0;colIndex<colCount;colIndex+=1){column=columnsToUpdate[colIndex];cellSelector=me.getCellSelector(column);oldCell=oldRow.selectNode(cellSelector);newCell=newRow.selectNode(cellSelector);newAttrs=newCell.attributes;attLen=newAttrs.length;for(attrIndex=0;attrIndex<attLen;attrIndex+=1){attName=newAttrs[attrIndex].name;if(attName!=='id'){oldCell.setAttribute(attName,newAttrs[attrIndex].value)}}elData=oldCell._extData;if(elData){elData.isSynchronized=false}oldCell=Ext.fly(oldCell).selectNode(me.innerSelector);newCell=Ext.fly(newCell).selectNode(me.innerSelector);Ext.fly(oldCell).syncContent(newCell)}},shouldUpdateCell:function(record,column,changedFieldNames){return column.shouldUpdateCell(record,changedFieldNames)},refresh:function(){var me=this,scroller;if(me.destroying){return}if(me.getVisibleColumnManager().getColumns().length){me.callParent(arguments);me.headerCt.setSortState()}else{if(me.refreshCounter){me.clearViewEl(true)}}},processContainerEvent:function(e){var cmp=Ext.Component.fromElement(e.target.parentNode);if(cmp&&cmp.up(this.ownerCt)){return false}},processItemEvent:function(record,item,rowIndex,e){var me=this,self=me.self,map=self.EventMap,type=e.type,features=me.features,len=features.length,i,cellIndex,result,feature,column,eventPosition=e.position=me.eventPosition||(me.eventPosition=new Ext.grid.CellContext()),row,cell;if(Ext.isIE&&type==='mouseup'&&!e.within(me.el)){return false}if(me.indexInStore(item)!==-1){row=eventPosition.rowElement=Ext.fly(item).down(me.rowSelector,true);cell=e.getTarget(me.getCellSelector(),row);type=self.TouchEventMap[type]||type;if(cell){if(!cell.parentNode){return false}column=me.getHeaderByCell(cell);if(column){cellIndex=me.ownerCt.getColumnManager().getHeaderIndex(column)}else{column=cell=null;cellIndex=-1}}else{cellIndex=-1}eventPosition.setAll(me,rowIndex,column?me.getVisibleColumnManager().getHeaderIndex(column):-1,record,column);eventPosition.cellElement=cell;result=me.fireEvent('uievent',type,me,cell,rowIndex,cellIndex,e,record,row);if((result===false||me.callParent(arguments)===false)){return false}for(i=0;i<len;i+=1){feature=features[i];if(feature.wrapsItem){if(feature.vetoEvent(record,row,rowIndex,e)===false){me.processSpecialEvent(e);return false}}}if(cell&&type!=='mouseover'&&type!=='mouseout'){result=!((me['onBeforeCell'+map[type]](cell,cellIndex,record,row,rowIndex,e)===false)||(me.fireEvent('beforecell'+type,me,cell,cellIndex,record,row,rowIndex,e)===false)||(me['onCell'+map[type]](cell,cellIndex,record,row,rowIndex,e)===false)||(me.fireEvent('cell'+type,me,cell,cellIndex,record,row,rowIndex,e)===false))}if(result!==false){result=me.fireEvent('row'+type,me,record,row,rowIndex,e)}return result}else{me.processSpecialEvent(e);if(e.pointerType==='mouse'){e.preventDefault()}return false}},processSpecialEvent:function(e){var me=this,features=me.features,ln=features.length,type=e.type,i,feature,prefix,featureTarget,beforeArgs,args,panel=me.ownerCt;me.callParent(arguments);if(type==='mouseover'||type==='mouseout'){return}type=me.self.TouchEventMap[type]||type;for(i=0;i<ln;i+=1){feature=features[i];if(feature.hasFeatureEvent){featureTarget=e.getTarget(feature.eventSelector,me.getTargetEl());if(featureTarget){prefix=feature.eventPrefix;beforeArgs=feature.getFireEventArgs('before'+prefix+type,me,featureTarget,e);args=feature.getFireEventArgs(prefix+type,me,featureTarget,e);if((me.fireEvent.apply(me,beforeArgs)===false)||(panel.fireEvent.apply(panel,beforeArgs)===false)||(me.fireEvent.apply(me,args)===false)||(panel.fireEvent.apply(panel,args)===false)){return false}}}}return true},onCellMouseDown:Ext.emptyFn,onCellLongPress:Ext.emptyFn,onCellMouseUp:Ext.emptyFn,onCellClick:Ext.emptyFn,onCellDblClick:Ext.emptyFn,onCellContextMenu:Ext.emptyFn,onCellKeyDown:Ext.emptyFn,onCellKeyUp:Ext.emptyFn,onCellKeyPress:Ext.emptyFn,onBeforeCellMouseDown:Ext.emptyFn,onBeforeCellLongPress:Ext.emptyFn,onBeforeCellMouseUp:Ext.emptyFn,onBeforeCellClick:Ext.emptyFn,onBeforeCellDblClick:Ext.emptyFn,onBeforeCellContextMenu:Ext.emptyFn,onBeforeCellKeyDown:Ext.emptyFn,onBeforeCellKeyUp:Ext.emptyFn,onBeforeCellKeyPress:Ext.emptyFn,expandToFit:function(header){this.autoSizeColumn(header)},autoSizeColumn:function(header){if(Ext.isNumber(header)){header=this.getGridColumns()[header]}if(header){if(header.isGroupHeader){header.autoSize();return}delete header.flex;header.setWidth(this.getMaxContentWidth(header))}},getMaxContentWidth:function(header){var me=this,cells=me.el.query(header.getCellInnerSelector()),originalWidth=header.getWidth(),i=0,ln=cells.length,columnSizer=me.body.select(me.getColumnSizerSelector(header)),max=Math.max,widthAdjust=0,maxWidth;if(ln>0){if(Ext.supports.ScrollWidthInlinePaddingBug){widthAdjust+=me.getCellPaddingAfter(cells[0])}if(me.columnLines){widthAdjust+=Ext.fly(cells[0].parentNode).getBorderWidth('lr')}}columnSizer.setWidth(1);header.textEl.setStyle({"text-overflow":'clip',display:'table-cell'});maxWidth=header.textEl.dom.offsetWidth+header.titleEl.getPadding('lr');header.textEl.setStyle({"text-overflow":'',display:''});for(;i<ln;i+=1){maxWidth=max(maxWidth,cells[i].scrollWidth)}maxWidth+=widthAdjust;maxWidth=max(maxWidth+1,40);columnSizer.setWidth(originalWidth);return maxWidth},getPositionByEvent:function(e){var me=this,cellNode=e.getTarget(me.cellSelector),rowNode=e.getTarget(me.itemSelector),record=me.getRecord(rowNode),header=me.getHeaderByCell(cellNode);return me.getPosition(record,header)},getHeaderByCell:function(cell){if(cell){return this.ownerGrid.getVisibleColumnManager().getHeaderById(Ext.getDom(cell).getAttribute('data-columnId'))}return false},walkCells:function(pos,direction,verifierFn,scope){var me=this,result=pos.clone(),lockingPartner=me.lockingPartner&&me.lockingPartner.grid.isVisible()?me.lockingPartner:null,rowIdx=pos.rowIdx,maxRowIdx=me.dataSource.getCount()-1,columns=me.ownerCt.getVisibleColumnManager().getColumns();switch(direction.toLowerCase()){case 'right':if(pos.isLastColumn()){rowIdx=lockingPartner&&me.isLockedView?rowIdx:rowIdx+1;if(rowIdx>maxRowIdx){return false}if(lockingPartner){result.view=lockingPartner}result.setPosition(rowIdx,0)}else{result.navigate(+1)}break;case 'left':if(pos.isFirstColumn()){rowIdx=lockingPartner&&me.isNormalView?rowIdx:rowIdx-1;if(rowIdx<0){return false}if(lockingPartner){result.view=lockingPartner;columns=lockingPartner.getVisibleColumnManager().getColumns()}result.setPosition(rowIdx,columns[columns.length-1])}else{result.navigate(-1)}break;case 'up':if(rowIdx===0){return false;}else{result.setRow(rowIdx-1)}break;case 'down':if(rowIdx===maxRowIdx){return false;}else{result.setRow(rowIdx+1)}break}if(verifierFn&&verifierFn.call(scope||me,result)!==true){return false}return result},walkRows:function(startRow,distance){var me=this,store=me.dataSource,moved=0,lastValid=startRow,node,limit=(distance<0)?0:store.getCount()-1,increment=limit?1:-1,result=startRow;do{if(limit?result>=limit:result<=limit){return lastValid||limit}result+=increment;if((node=Ext.fly(me.getRow(result)))&&node.isVisible(true)){moved+=increment;lastValid=result}}while(moved!==distance);return result},walkRecs:function(startRec,distance){var me=this,store=me.dataSource,moved=0,lastValid=startRec,node,limit=(distance<0)?0:(store.isBufferedStore?store.getTotalCount():store.getCount())-1,increment=limit?1:-1,testIndex=store.indexOf(startRec),rec;do{if(limit?testIndex>=limit:testIndex<=limit){return lastValid}testIndex+=increment;rec=store.getAt(testIndex);if(!rec.isCollapsedPlaceholder&&(node=Ext.fly(me.getNodeByRecord(rec)))&&node.isVisible(true)){moved+=increment;lastValid=rec}}while(moved!==distance);return lastValid},getFirstVisibleRowIndex:function(){var me=this,count=(me.dataSource.isBufferedStore?me.dataSource.getTotalCount():me.dataSource.getCount()),result=me.indexOf(me.all.first())-1;do{result+=1;if(result===count){return}}while(!Ext.fly(me.getRow(result)).isVisible(true));return result},getLastVisibleRowIndex:function(){var me=this,result=me.indexOf(me.all.last());do{result-=1;if(result===-1){return}}while(!Ext.fly(me.getRow(result)).isVisible(true));return result},getHeaderCt:function(){return this.headerCt},getPosition:function(record,header){return new Ext.grid.CellContext(this).setPosition(record,header)},doDestroy:function(){var me=this,features=me.featuresMC,feature,i,len;me.bindStore(null);if(features){for(i=0,len=features.getCount();i<len;i+=1){feature=features.getAt(i);if(feature&&!feature.destroyed){feature.destroy()}}}me.all.destroy();me.body.destroy();me.callParent()},onReplace:function(store,startIndex,oldRecords,newRecords){var me=this,bufferedRenderer=me.bufferedRenderer,restoreFocus;if(me.rendered&&bufferedRenderer){restoreFocus=me.saveFocusState();bufferedRenderer.onReplace(store,startIndex,oldRecords,newRecords);restoreFocus()}else{me.callParent(arguments)}me.setPendingStripe(startIndex)},onResize:function(width,height,oldWidth,oldHeight){var me=this,bufferedRenderer=me.bufferedRenderer;if(bufferedRenderer){bufferedRenderer.onViewResize(me,width,height,oldWidth,oldHeight)}me.callParent([width,height,oldWidth,oldHeight])},onAdd:function(store,records,index){var me=this,bufferedRenderer=me.bufferedRenderer;me.addingRows=true;if(me.rendered&&bufferedRenderer&&(bufferedRenderer.bodyTop||me.dataSource.getCount()+records.length>=bufferedRenderer.viewSize)){bufferedRenderer.onReplace(store,index,[],records)}else{me.callParent(arguments)}me.setPendingStripe(index);me.addingRows=false},onRemove:function(store,records,index){var me=this,bufferedRenderer=me.bufferedRenderer,restoreFocus;if(me.rendered&&bufferedRenderer&&me.dataSource.getCount()+records.length>=bufferedRenderer.viewSize){restoreFocus=me.saveFocusState();bufferedRenderer.onReplace(store,index,records,[]);restoreFocus()}else{me.callParent(arguments)}if(me.actionPosition&&Ext.Array.indexOf(records,me.actionPosition.record)!==-1){me.actionPosition=null}me.setPendingStripe(index)},saveFocusState:function(){var me=this,store=me.dataSource,actionableMode=me.actionableMode,navModel=me.getNavigationModel(),focusPosition=actionableMode?me.actionPosition:navModel.getPosition(true),activeElement=Ext.Element.getActiveElement(true),focusCell=focusPosition&&focusPosition.view===me&&focusPosition.getCell(),refocusRow,refocusCol;if(focusCell&&focusCell.contains(activeElement)){focusPosition=focusPosition.clone();activeElement.suspendFocusEvents();if(actionableMode&&focusCell!==activeElement){me.suspendActionableMode();}else{actionableMode=false;navModel.setPosition()}activeElement.resumeFocusEvents();return function(){store=me.dataSource;if(store.getCount()){refocusRow=Math.min(focusPosition.rowIdx,me.all.getCount()-1);refocusCol=Math.min(focusPosition.colIdx,me.getVisibleColumnManager().getColumns().length-1);focusPosition=new Ext.grid.CellContext(me).setPosition(store.contains(focusPosition.record)?focusPosition.record:refocusRow,refocusCol);if(actionableMode){me.resumeActionableMode(focusPosition)}else{navModel.setPosition(focusPosition,null,null,null,true)}}else{focusPosition.column.focus()}}}return Ext.emptyFn},onDataRefresh:function(store){var me=this,owner=me.ownerCt;if(owner&&owner.isCollapsingOrExpanding===2){owner.on('expand',me.onDataRefresh,me,{single:true});return}me.callParent([store])},getViewRange:function(){var me=this;if(me.bufferedRenderer){return me.bufferedRenderer.getViewRange()}return me.callParent()},setPendingStripe:function(index){var current=this.stripeOnUpdate;if(current===null){current=index}else{current=Math.min(current,index)}this.stripeOnUpdate=current},onEndUpdate:function(){var me=this,stripeOnUpdate=me.stripeOnUpdate,startIndex=me.all.startIndex;if(me.rendered&&(stripeOnUpdate||stripeOnUpdate===0)){if(stripeOnUpdate<startIndex){stripeOnUpdate=startIndex}me.doStripeRows(stripeOnUpdate);me.stripeOnUpdate=null}me.callParent(arguments)},doStripeRows:function(startRow,endRow){var me=this,rows,rowsLn,i,row;if(me.rendered&&me.stripeRows){rows=me.getNodes(startRow,endRow);for(i=0,rowsLn=rows.length;i<rowsLn;i+=1){row=rows[i];row.className=row.className.replace(me.rowClsRe,' ');startRow+=1;if(startRow%2===0){row.className+=(' '+me.altRowCls)}}}},hasActiveFeature:function(){return(this.isGrouping&&this.store.isGrouped())||this.isRowWrapped},getCellPaddingAfter:function(cell){return Ext.fly(cell).getPadding('r')},privates:{collectNodes:function(targetEl){this.all.fill(this.getNodeContainer().childNodes,this.all.startIndex)},setActionableMode:function(enabled,position){var me=this,navModel=me.getNavigationModel(),activeEl,actionables=me.grid.actionables,len=actionables.length,i,record,column,isActionable=false,lockingPartner,cell;if(me.actionableMode===enabled){if(!enabled||position.isEqual(me.actionPosition)){return false}}if(enabled){if(position&&(position.view===me||(position.view===(lockingPartner=me.lockingPartner)&&lockingPartner.actionableMode))){isActionable=me.activateCell(position)}return isActionable}else{activeEl=Ext.fly(Ext.Element.getActiveElement());if(me.el.contains(activeEl)&&!Ext.fly(activeEl).is(me.getCellSelector())){record=(me.actionPosition&&me.actionPosition.record)||me.getRecord(activeEl);column=me.getHeaderByCell(activeEl.findParent(me.getCellSelector()));cell=position&&position.getCell();if(!position||!cell){position=new Ext.grid.CellContext(me).setPosition(record||0,column||0);cell=position.getCell()}cell.focus();activeEl=Ext.fly(Ext.Element.getActiveElement());if(!(me.el.contains(activeEl)&&activeEl.is(me.getCellSelector()))){position=null}}for(i=0;i<len;i+=1){if(actionables[i].deactivate){actionables[i].deactivate()}}if(me.actionRow){me.actionRow.saveTabbableState({skipSelf:true,includeSaved:false})}if(me.destroyed){return false}me.actionableMode=me.ownerGrid.actionableMode=false;me.actionPosition=navModel.actionPosition=me.actionRow=null;if(position){navModel.setPosition(position)}}},activateCell:function(position){var me=this,lockingPartner=position.view!==me?me.lockingPartner:null,actionables=me.grid.actionables,len=actionables.length,navModel=me.getNavigationModel(),record,prevRow,focusRow,focusCell,i,isActionable,tabbableChildren;position=position.clone();record=position.record;position.view.grid.ensureVisible(record,{column:position.column});focusRow=me.all.item(position.rowIdx);if(me.actionPosition){prevRow=Ext.get(me.all.item(me.actionPosition.rowIdx,true));if(prevRow&&focusRow!==prevRow){prevRow.saveTabbableState({skipSelf:true,includeSaved:false})}}me.activating=true;if(!lockingPartner){focusCell=position.getCell();me.actionPosition=position;for(i=0;i<len;i+=1){isActionable=isActionable||actionables[i].activateCell(position,null,true)}}if(lockingPartner||(focusCell&&(focusCell.restoreTabbableState(true).length|(tabbableChildren=focusCell.findTabbableElements()).length))||isActionable){for(i=0;i<len;i+=1){if(actionables[i].activateRow){actionables[i].activateRow(focusRow)}}if(lockingPartner||tabbableChildren.length){focusRow.restoreTabbableState(true);if(lockingPartner){me.actionableMode=true;me.actionPosition=null;me.activating=false;return true}if(tabbableChildren){me.actionRow=focusRow;me.actionableMode=me.ownerGrid.actionableMode=true;navModel.setPosition();navModel.actionPosition=me.actionPosition=position;Ext.fly(tabbableChildren[0]).focus();me.activating=false;return true}}}me.activating=false},suspendActionableMode:function(){var me=this,actionables=me.grid.actionables,len=actionables.length,i;for(i=0;i<len;i+=1){actionables[i].suspend()}},resumeActionableMode:function(position){var me=this,actionables=me.grid.actionables,len=actionables.length,i,activated;me.toggleChildrenTabbability(false);for(i=0;i<len;i+=1){activated=activated||actionables[i].resume(position)}if(!activated){me.activateCell(position)}},onRowExit:function(keyEvent,prevRow,newRow,forward,wrapDone){var me=this,direction=forward?'nextSibling':'previousSibling',lockingPartner=me.lockingPartner,rowIdx,cellIdx;if(lockingPartner&&lockingPartner.grid.isVisible()){rowIdx=me.all.indexOf(prevRow);if(forward){cellIdx=0;if(me.isNormalView){rowIdx+=1}}else{cellIdx=lockingPartner.getVisibleColumnManager().getColumns().length-1;if(me.isLockedView){rowIdx-=1}}me.actionPosition=null;me=lockingPartner;newRow=me.all.item(rowIdx,true)}if(!me.hasListeners.beforerowexit||me.fireEvent('beforerowexit',me,keyEvent,prevRow,newRow,forward)!==false){me.findFirstActionableElement(keyEvent,newRow,direction,forward,wrapDone)}else{return false}},findFirstActionableElement:function(keyEvent,focusRow,direction,forward,wrapDone){var me=this,columns=me.getVisibleColumnManager().getColumns(),columnCount=columns.length,actionables=me.grid.actionables,actionableCount=actionables.length,position=new Ext.grid.CellContext(me),focusCell,focusTarget,i,j,column,isActionable,tabbableChildren,prevRow;if(focusRow){position.setRow(focusRow);for(i=0;i<actionableCount;i+=1){if(actionables[i].activateRow){actionables[i].activateRow(focusRow)}}for(i=(forward?0:columnCount-1);(forward?i<columnCount:i>-1)&&!focusTarget;i=i+(forward?1:-1)){column=columns[i];position.setColumn(column);focusCell=Ext.fly(focusRow).down(position.column.getCellSelector());for(j=0;j<actionableCount;j+=1){isActionable=isActionable||actionables[j].activateCell(position)}focusCell=position.getCell();if(focusCell){focusRow=position.getNode(true);focusCell.restoreTabbableState(true);if((tabbableChildren=focusCell.findTabbableElements()).length||isActionable){prevRow=me.actionRow;me.actionRow=Ext.get(focusRow);me.actionRow.restoreTabbableState(true);focusTarget=tabbableChildren[forward?0:tabbableChildren.length-1]}}}if(focusTarget){me.actionPosition=me.getNavigationModel().actionPosition=position;Ext.fly(focusTarget).focus(Ext.asyncFocus?1:0);if(prevRow&&focusRow!==prevRow.dom){prevRow.saveTabbableState({skipSelf:true,includeSaved:false})}}else{me.onRowExit(keyEvent,focusRow,me.all.item(position.rowIdx+(forward?1:-1)),forward,wrapDone);}}else if(!wrapDone){me.grid.ensureVisible(forward?0:me.dataSource.getCount()-1,{callback:function(success,record,row){if(success){me.findFirstActionableElement(keyEvent,row,direction,forward,true)}else{me.ownerGrid.setActionableMode(false)}}})}else{me.ownerGrid.setActionableMode(false)}},stretchHeight:function(height){var me=this,scroller=me.getScrollable(),stretchers=me.stretchers,shortfall;if(height&&me.tabGuardEl){if(stretchers){stretchers[0].style.marginTop=stretchers[1].style.marginTop=me.el.dom.style.height=0}me.el.dom.style.height=scroller.constrainScrollRange(height)+'px';shortfall=height-me.el.dom.offsetHeight;if(shortfall>0){me.el.dom.style.height='';stretchers=me.getStretchers();shortfall=height-me.el.dom.offsetHeight;if(shortfall>0){stretchers[0].style.marginTop=scroller.constrainScrollRange(shortfall)+'px';shortfall=height-me.el.dom.offsetHeight;if(shortfall>0){stretchers[1].style.marginTop=Math.min(shortfall,scroller.maxSpacerMargin||0)+'px'}}}}},getStretchers:function(){var me=this,stretchers=me.stretchers,stretchCfg;if(stretchers){me.el.appendChild(stretchers)}else{stretchCfg={cls:'x-scroller-spacer',style:'position:relative'};stretchers=me.stretchers=me.el.appendChild([stretchCfg,stretchCfg],true)}return stretchers}}});